pattern CVE-2020-27376

patt {
    use std::net::{SocketAddrV4, SocketAddrV6};

    p_v4 = p[$T = SocketAddrV4];
    p_v6 = p[$T = SocketAddrV6];
}

util {
    use libc::sockaddr;

    p[$T: type] = #[mir] fn _() {
        'cast_from:
        let $src: *const $T = _;
        'cast_to:
        let $dst: *const sockaddr = move $src as *const sockaddr (PtrToPtr);
    }
}

diag {
    p_v4 = {
        primary(cast)  = "wrong assumption of layout compatibility from `SocketAddrV4` to `sockaddr`",
        label(cast_to) = "casted to `sockaddr` here",
        note           = "casted from this",
        help           = "it's not guaranteed by Rust standard library. See https://github.com/rust-lang/rust/pull/78802",
    }
    p_v6 = {
        primary(cast)  = "wrong assumption of layout compatibility from `SocketAddrV6` to `sockaddr`",
        label(cast_to) = "casted to `sockaddr` here",
        note           = "casted from this",
        help           = "it's not guaranteed by Rust standard library. See https://github.com/rust-lang/rust/pull/78802",
    }
}
